{% extends "base.html" %}

{% block content %}

<style>


    #topBar>div {
        display: inline-block;
    }

    #root {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding: 0.5em;
        /* weird flexbox scroll approach */
        height: 0px;
    }

    /* #topBar {
        min-height: 2em;
    } */

    #mainBody {
        flex-grow: 1;
        overflow-y: auto;
        margin-right: 0.1em;
        
    }

    .entry {
        padding: 0;
        margin-top: 0.5em;
        border-radius: 0 0.5em;
        border-bottom: 1px solid rgb(204, 204, 204);
        border-right: 1px solid rgb(194, 194, 194);
        transition: background 0.3s ease-in-out;
    }
    
    .entry:hover{
        
        background: #f0f0f0;
    }

    .timeStamp {
        text-align: right;
        padding-right: 1em;
        font-size: 0.8em;
        color: rgba(0,0,0,0.5);
        font-style: italic;
        font-weight: bold;
        padding-bottom: 0.3em;
    }

    .entryBody {
        font-size: 1.1em;
        /* to parse \n as new line i.e. <br> */
        white-space: pre-wrap;
    }

    .entryTags {
        font-size: 0.7em;
        text-align: right;
        padding: 0 1em;
    }

    #textarea {
        width: 100%;
        height: 9em;
    }

    #newEntry {
        height: 10em;
        padding-top: 0.5em;
    }

    .distFree{
        transition: opacity 0.3s ease-in-out;
    }


    #topBar{
        width: 100%;
        height: 3em;
        padding-bottom: 0.5em;
        display: flex;
        flex-direction: row;
    }
    #topBar>*{
        margin: 0 0.3em;
    }

    #topBar>*:first-child{
        flex-grow: 1;
        vertical-align:middle;
    }
    #tagSelector{
        width: 100%;
    }

</style>

</head>

<body>

    <div id="root">

        <div id="topBar" class="distFree remove">
            <input class="form-control" type="text" name="" id="searchInput" style="height: 100%;" placeholder="Search the entries">
            <button class="btn btn-info" id ='searchButton'>Search</button>
        </div>

        <div id="tagContainer" class="distFree remove">

            <select class="selectpicker form-control " multiple data-live-search="true" title="Chose a tag" id="tagSelector"></select>
        </div>
          

        <div id="mainBody" class="distFree">

            <div class="entry">
                <div class="timeStamp">23rd December</div>
                <div class="entryBody"> This a simple diary log</div>
                <div class="entryTags ">kou, test, hh, ddd</div>
            </div>


            <div class="entry">
                <div class="timeStamp">23rd December</div>
                <div class="entryBody"> This a simple diary log</div>
                <div class="entryTags">kou, test, hh, ddd</div>
            </div>
        </div>
        <div class="pagination"  class="distFree">
        </div>
        <div id="newEntry">
            <textarea name="" id="textarea" rows="7" class="form-control"></textarea>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>

        const url = "/api/entries/"
        var todoList;

        // document.onload=()=>{
        //     // $('select').selectpicker();
        //     buildTagList()
        // }

        function buildTagList(){
            const elem = document.getElementById('tagSelector');
            fetch("/listTags").then(res => res.json()).then(function (res) {
                console.log(res)
                const inn = res.tags.map(e=>`<option>${e}</option>`).join('')
                console.log(inn)
                elem.innerHTML = inn
            }).then(()=>{

                $(elem).selectpicker('refresh');
            })

        }

        function searchThis(event) {
            event.preventDefault()
            createEntryList(event.target.value)
        }

        document.getElementById("searchButton").onclick=()=>{
            const searchTerm = document.getElementById("searchInput").value
            createEntryList(searchTerm)
        }


        function test(ev){
            console.log(ev)
        }

        // cokie validation
        function getCookie(name) { // copied from django doc
            if (!document.cookie) {
                return null;
            }
            const token = document.cookie.split(';')
                .map(c => c.trim())
                .filter(c => c.startsWith(name + '='));

            if (token.length === 0) {
                return null;
            }
            return decodeURIComponent(token[0].split('=')[1]);
        }
        const headers = {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}' //getCookie('csrftoken')
        }


        const re = /(?:^|\W)#(\w+)(?!\w)/g
        document.getElementById('textarea').onkeydown = (e) => {
            if (e.keyCode == 13 && e.ctrlKey) {
                e.preventDefault();
                console.log(e.target.value)
                const val = e.target.value 
                const tags = [...val.matchAll(re)].map(e=>e[1])
                // const bodyText = val.replaceAll(re, "") // remove the tags from the text
                fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        "desc": val,
                        "tags": tags.join()
                    })
                }
                ).then(function (res) {
                    // console.log(res)
                    if (res.status == 201) {
                        createEntryList()
                        e.target.value = '' // clear the textarea
                    }
                })
            }
        }


        // function logOutUser() {
        //     fetch('/logout/', {
        //         method: 'POST',
        //         headers: {
        //             'X-CSRFToken': '{{ csrf_token }}' //getCookie('csrftoken')
        //         },
        //         data: {}
        //     }).then(function (res) {
        //         window.location.href = '/'
        //     }
        //     )
        // }


        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            })
        }


        // GET request, list all todos
        function createEntryList(searchparams) {
            let slug = searchparams != undefined ? `?search=${searchparams}` : ''
            fetch(url + slug).then(res => res.json()).then(function (res) {

                const elem = document.getElementById('mainBody')
                const result = res.results
                const next = res.links.next
                const prev = res.links.previous
                console.log(res)
                // keep the tags inside and hide them when inserting the html element
                elem.innerHTML = result.map(el =>
                    `<div class="entry">
                        <div class="timeStamp">${formatDate(el.created)}</div>
                        <div class="entryBody"> ${el.desc.replaceAll(re, "")}</div>
                        <div class="entryTags">${el.tags}</div>
                    </div>`).join('\n')
                elem.scrollTop = elem.scrollHeight - elem.clientHeight;
            })
        }
        createEntryList()





        // // PUT request , modify a entry 

        // // checking a entry
        // function checkToDo(id) {
        //     fetch(url + `${id}/`).then(res => res.json()).then(function (res) {

        //         comStat = !res.completed
        //         fetch(url + `${id}/`, {
        //             method: "PUT",
        //             headers: {
        //                 'Content-Type': 'application/json',
        //                 'X-CSRFToken': '{{ csrf_token }}'//getCookie('csrftoken')
        //             },
        //             body: JSON.stringify({
        //                 'completed': comStat,
        //                 'datecompleted': comStat ? new Date().toISOString() : null
        //             })
        //         }).then(function (ret) {
        //             if (ret.status == 200) {
        //                 createEntryList()
        //             }
        //         })
        //     })

        // }





        // // DELETE request, remove a entry
        // function deleteThisTodo(item) {
        //     fetch(`${url}${item}/`, {
        //         method: 'DELETE',
        //         headers: headers,
        //     }).then(function (response) {
        //         // console.log(response)
        //         if (response.status == 204) {
        //             createEntryList()
        //         }
        //     })
        // }



        document.getElementById('searchElem').onclick=()=>{
            document.getElementById('topBar').classList.toggle('remove')
        }

        document.getElementById('tagElem').onclick=()=>{
            if (document.getElementById('tagContainer').classList.contains('remove')) buildTagList();
            document.getElementById('tagContainer').classList.toggle('remove')
        }

        // keyboard shortcuts
        window.onkeyup = (e)=>{
            if(e.ctrlKey && e.shiftKey){
                if(e.key==')'){
                    for (let el of document.getElementsByClassName('distFree') ) el.classList.toggle('hide');
            
                }else{
                    console.log(e.key)
                }
            }
        }


    </script>

    {% endblock %}